<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Support Buddy">
    <meta name="theme-color" content="#667eea">
    
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%23667eea' width='100' height='100'/><text y='70' x='50' text-anchor='middle' font-size='60' fill='white'>ü§ù</text></svg>">
    
    <title>Student Support Buddy</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background: white;
            max-width: 100%;
            width: 100%;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        @media (min-width: 768px) {
            body { padding: 20px; }
            .container {
                border-radius: 20px;
                max-width: 900px;
                height: 90vh;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            }
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 20px;
            margin-bottom: 3px;
        }

        .header p {
            font-size: 12px;
            opacity: 0.9;
        }

        .new-chat-btn {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
        }

        .chat-area {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: #f5f5f5;
            -webkit-overflow-scrolling: touch;
        }

        .message {
            margin-bottom: 12px;
            display: flex;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.bot { justify-content: flex-start; }
        .message.user { justify-content: flex-end; }

        .message-bubble {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 15px;
            word-wrap: break-word;
            font-size: 14px;
            line-height: 1.6;
        }

        .message.bot .message-bubble {
            background: #e3f2fd;
            color: #1976d2;
            border-bottom-left-radius: 4px;
        }

        .message.user .message-bubble {
            background: #c8e6c9;
            color: #388e3c;
            border-bottom-right-radius: 4px;
        }

        .message.bot .message-bubble a {
            color: #d32f2f;
            font-weight: 600;
            text-decoration: none;
            border-bottom: 1px solid #d32f2f;
        }

        .sample-questions {
            padding: 12px 15px;
            background: #f9f9f9;
            border-top: 1px solid #e0e0e0;
            flex-shrink: 0;
        }

        .sample-questions h3 {
            font-size: 13px;
            color: #666;
            margin-bottom: 10px;
            text-align: center;
        }

        .questions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 8px;
            max-height: 120px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        @media (max-width: 768px) {
            .questions-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .sample-question {
            padding: 10px 12px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            cursor: pointer;
            font-size: 13px;
            text-align: center;
            color: #555;
            transition: all 0.3s;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .sample-question:active {
            background: #667eea;
            color: white;
            border-color: #667eea;
            transform: scale(0.95);
        }

        .input-area {
            padding: 12px;
            background: white;
            border-top: 1px solid #e0e0e0;
        }

        .input-group {
            display: flex;
            gap: 8px;
        }

        #userInput {
            flex: 1;
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 20px;
            font-size: 14px;
            outline: none;
        }

        #userInput:focus {
            border-color: #667eea;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }

        .btn-send {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .voice-controls {
            padding: 10px;
            background: white;
            display: flex;
            justify-content: center;
            gap: 6px;
            border-top: 1px solid #e0e0e0;
        }

        .btn-voice {
            padding: 8px 15px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
        }

        .btn-voice.active {
            background: #667eea;
            color: white;
        }

        .footer {
            padding: 10px;
            background: #f5f5f5;
            border-top: 1px solid #e0e0e0;
            text-align: center;
        }

        .privacy-notice {
            font-size: 10px;
            color: #666;
            margin-bottom: 6px;
        }

        .emergency-info {
            font-size: 11px;
            color: #d32f2f;
            font-weight: 600;
        }

        .emergency-link {
            color: #d32f2f;
            text-decoration: none;
            border-bottom: 1px solid #d32f2f;
        }

        .typing-indicator {
            display: none;
            padding: 10px 15px;
            background: #e3f2fd;
            border-radius: 15px;
            border-bottom-left-radius: 4px;
            width: fit-content;
        }

        .typing-indicator span {
            display: inline-block;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #1976d2;
            margin: 0 2px;
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-8px); }
        }

        .quick-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            margin: 15px 0;
            animation: slideIn 0.3s ease;
        }

        .quick-button {
            background: white;
            border: 2px solid #667eea;
            color: #667eea;
            padding: 10px 18px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .quick-button:active {
            background: #667eea;
            color: white;
            transform: scale(0.95);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active { display: flex; }

        .modal-content {
            background: white;
            border-radius: 15px;
            max-width: 400px;
            width: 100%;
            padding: 20px;
            text-align: center;
        }

        .modal-content h3 {
            margin-bottom: 12px;
            color: #667eea;
        }

        .modal-content p {
            margin-bottom: 15px;
            color: #666;
            font-size: 14px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 18px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
        }

        .modal-btn.confirm {
            background: #667eea;
            color: white;
        }

        .modal-btn.cancel {
            background: #e0e0e0;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="new-chat-btn" onclick="confirmNewChat()">üîÑ New</button>
            <h1>ü§ù Student Support Buddy</h1>
            <p>Your Safe Space - We're Here to Listen</p>
        </div>

        <div class="chat-area" id="chatArea">
            <div class="message bot">
                <div class="message-bubble">
                    Hey there! üëã I'm your Student Support Buddy. Before we start, what grade are you in? This helps me understand you better.
                </div>
            </div>
            <div class="typing-indicator" id="typingIndicator">
                <span></span><span></span><span></span>
            </div>
        </div>

        <div class="sample-questions">
            <h3>üí≠ Not sure what to say? Try these:</h3>
            <div class="questions-grid">
                <div class="sample-question" onclick="askQuestion('I am being bullied')">
                    üòî I'm being bullied
                </div>
                <div class="sample-question" onclick="askQuestion('Feeling peer pressure')">
                    üò∞ Feeling peer pressure
                </div>
                <div class="sample-question" onclick="askQuestion('I feel lonely')">
                    üò¢ Feeling lonely
                </div>
                <div class="sample-question" onclick="askQuestion('Stressed about studies')">
                    üìö Stressed about studies
                </div>
                <div class="sample-question" onclick="askQuestion('Family problems')">
                    üè† Family problems
                </div>
                <div class="sample-question" onclick="askQuestion('Someone is spreading rumors about me')">
                    ü§´ Dealing with rumors
                </div>
                <div class="sample-question" onclick="askQuestion('They exclude me every day')">
                    üòû Being excluded
                </div>
                <div class="sample-question" onclick="askQuestion('Someone posted mean things online')">
                    üì± Cyberbullying
                </div>
                <div class="sample-question" onclick="askQuestion('I am not safe right now')">
                    üö® Not safe
                </div>
            </div>
        </div>

        <div class="input-area">
            <div class="input-group">
                <input type="text" id="userInput" placeholder="Type your message..." onkeypress="handleKeyPress(event)">
                <button class="btn btn-send" id="sendBtn" onclick="sendMessage()">Send</button>
            </div>
        </div>

        <div class="voice-controls">
            <button class="btn-voice" onclick="speakMessage()" id="speakBtn">üîä Speak</button>
            <button class="btn-voice" onclick="stopSpeaking()">‚èπÔ∏è Stop</button>
            <button class="btn-voice" onclick="repeatMessage()">üîÅ Repeat</button>
        </div>

        <div class="footer">
            <div class="privacy-notice">üîí Private & Confidential</div>
            <div class="emergency-info">
                Emergency: <a href="tel:1098" class="emergency-link">CHILDLINE 1098</a>
            </div>
        </div>
    </div>

    <div class="modal" id="newChatModal">
        <div class="modal-content">
            <h3>Start New Chat?</h3>
            <p>This will clear your current conversation. Continue?</p>
            <div class="modal-buttons">
                <button class="modal-btn confirm" onclick="startNewChat()">Yes</button>
                <button class="modal-btn cancel" onclick="closeNewChatModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        let lastBotMessage = '';
        let currentSpeech = null;
        let responseCount = 4;
        let conversationTurns = 0;
        let hasShownHelpMessage = false;
        let hasTalkedToAdult = false;
        let problemDiscussionStarted = false;
        let userContext = {
            ageGroup: null,
            bullyingType: null,
            hasBasicInfo: false
        };

        // Top 10 tuned responses from dataset
        const knowledgeBase = {
            'feeling_hurt': {
                keywords: ['making fun', 'laugh at me', 'mock', 'tease', 'call me', 'ugly', 'hurt'],
                response: "I'm sorry you're going through this. You don't deserve to be treated that way. I'm here with you. What's been happening, and when did it start?",
                tone: 'warm',
                followUp: 'understanding'
            },
            'exclusion': {
                keywords: ['exclude', 'left out', 'ignore', 'don\'t invite', 'never let me', 'move away', 'leave me out'],
                response: "If something is repeated, targeted, and makes you feel unsafe or hurt, it may be bullying. Even if they call it a 'joke,' your feelings matter. Can you tell me more about how often this happens?",
                tone: 'supportive',
                followUp: 'frequency'
            },
            'cyberbullying': {
                keywords: ['online', 'posted', 'comments', 'social media', 'instagram', 'whatsapp', 'mean messages', 'dm'],
                response: "That's not okay, and you don't deserve it. First, don't respond to them. If you can, take screenshots to save the evidence, then block and report the account. It's also important to tell a trusted adult about this.",
                tone: 'practical',
                followUp: 'evidence'
            },
            'feeling_anxious': {
                keywords: ['anxious', 'nervous', 'worried', 'stomach', 'panic', 'scared'],
                response: "Take a deep breath with me - you're safe right now. It's completely normal to feel anxious when dealing with bullying. Let's take this one step at a time. What's making you feel most anxious?",
                tone: 'calm',
                followUp: 'grounding'
            },
            'calm_down': {
                keywords: ['calm down', 'can\'t breathe', 'shaking', 'heart racing', 'panicking'],
                response: "Let's take one small step together. Try this: breathe in slowly for 4 counts, hold for 2, then breathe out for 6 counts. Do this a few times. You're going to be okay. Once you feel a bit calmer, we can talk about what to do next.",
                tone: 'coaching',
                followUp: 'breathing'
            },
            'reporting': {
                keywords: ['tell teacher', 'tell parents', 'report', 'counselor', 'how do i tell'],
                response: "Reaching out for help is a brave and strong move. A teacher, school counselor, or parent can help you stay safe and take real action. If you want, I can help you plan what to say and what details to share with them.",
                tone: 'empowering',
                followUp: 'planning'
            },
            'physical': {
                keywords: ['push', 'hit', 'kick', 'punch', 'shove', 'hurt me', 'physical'],
                response: "Physical bullying is serious and not okay. If someone is hurting you physically, this needs to stop. Have you told any adult about this? A teacher or parent needs to know so they can keep you safe.",
                tone: 'serious',
                followUp: 'safety_check'
            },
            'bystander': {
                keywords: ['saw bullying', 'witnessed', 'saw someone', 'friend is bullied', 'someone else'],
                response: "Thanks for caring - that shows real courage. The safest thing is to get an adult's help right away. Stay with the person being targeted if you can. You're doing the right thing by wanting to help.",
                tone: 'encouraging',
                followUp: 'action_steps'
            },
            'rumors': {
                keywords: ['rumor', 'spreading', 'gossip', 'saying things', 'not true', 'lies'],
                response: "Rumors can hurt deeply, and I'm sorry this is happening to you. Even if they call it 'drama' or a 'joke,' your feelings matter. Can you tell me who is spreading these rumors and how it's affecting you?",
                tone: 'validating',
                followUp: 'impact'
            },
            'immediate_danger': {
                keywords: ['not safe', 'danger', 'right now', 'scared right now', 'help now', 'emergency'],
                response: "I'm really glad you told me. Your safety is the most important thing. If you are in immediate danger RIGHT NOW, please find a trusted adult nearby or call emergency services immediately. Can you get to a safe place?",
                tone: 'urgent',
                followUp: 'immediate_action',
                escalation: true
            }
        };

        function detectIntent(message) {
            const lowerMessage = message.toLowerCase();
            
            // Check if gathering context
            if (!userContext.hasBasicInfo) {
                if (!userContext.ageGroup) {
                    if (lowerMessage.match(/\b([1-9]|1[0-2])(th|st|nd|rd)?\s*(grade|class)?\b/i) || 
                        lowerMessage.match(/\b(elementary|middle|high|primary|secondary)\b/i)) {
                        userContext.ageGroup = 'collected';
                        return 'age_collected';
                    }
                }
                
                if (userContext.ageGroup && !userContext.bullyingType) {
                    if (lowerMessage.match(/\b(online|cyber|social media|internet|post)\b/i)) {
                        userContext.bullyingType = 'cyber';
                        userContext.hasBasicInfo = true;
                        return 'context_complete_cyber';
                    } else if (lowerMessage.match(/\b(school|class|physical|person)\b/i)) {
                        userContext.bullyingType = 'physical';
                        userContext.hasBasicInfo = true;
                        return 'context_complete_physical';
                    } else if (lowerMessage.match(/\bboth\b/i)) {
                        userContext.bullyingType = 'both';
                        userContext.hasBasicInfo = true;
                        return 'context_complete_both';
                    }
                    return 'type_collecting';
                }
            }
            
            // Match to knowledge base
            let bestMatch = null;
            let maxMatches = 0;

            for (const [intent, data] of Object.entries(knowledgeBase)) {
                let matches = 0;
                for (const keyword of data.keywords) {
                    if (lowerMessage.includes(keyword)) {
                        matches++;
                    }
                }
                if (matches > maxMatches) {
                    maxMatches = matches;
                    bestMatch = intent;
                }
            }

            return bestMatch || 'general';
        }

        function getBotResponse(userMessage) {
            const intent = detectIntent(userMessage);
            
            // Context gathering
            if (intent === 'age_collected') {
                return {
                    response: "Thank you for sharing! Now, where is the bullying happening - at school, online, or both?",
                    escalation: false,
                    showContextButtons: true,
                    isContextGathering: true
                };
            }
            
            if (intent === 'type_collecting') {
                return {
                    response: "Just to understand better - is this happening at school, online (social media, messages), or both?",
                    escalation: false,
                    showContextButtons: true,
                    isContextGathering: true
                };
            }
            
            if (intent.startsWith('context_complete')) {
                problemDiscussionStarted = true;
                responseCount = 4;
                return {
                    response: "Thank you for trusting me with this. I understand this must be really difficult. Take a deep breath - you're safe here with me. Can you tell me what exactly has been happening? Share as much or as little as you're comfortable with.",
                    escalation: false,
                    isContextGathering: false
                };
            }
            
            // If sharing problem without context, acknowledge then ask
            if (!userContext.hasBasicInfo && intent !== 'general' && !knowledgeBase[intent]?.escalation) {
                const baseResponse = knowledgeBase[intent]?.response || "I'm sorry you're going through this.";
                return {
                    response: baseResponse + "\n\nBefore we continue, what grade are you in? This helps me support you better.",
                    escalation: false,
                    showGradeButtons: true,
                    isContextGathering: true
                };
            }
            
            // Crisis escalation
            if (knowledgeBase[intent]?.escalation) {
                return {
                    response: knowledgeBase[intent].response,
                    escalation: true,
                    isContextGathering: false
                };
            }
            
            // Normal problem discussion
            if (intent === 'general') {
                return {
                    response: "I'm listening. Can you tell me more about what's happening?",
                    escalation: false,
                    isContextGathering: false
                };
            }
            
            return {
                response: knowledgeBase[intent]?.response || "I hear you. Tell me more.",
                escalation: false,
                isContextGathering: false
            };
        }

        function checkAdultConversation() {
            if (hasShownHelpMessage) return;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot';
            messageDiv.innerHTML = `
                <div class="message-bubble">
                    Take a moment and breathe - you're doing great by reaching out. üåü
                    <br><br>
                    Now, I want to ask: have you been able to talk to any trusted adults about this - like your parents, a teacher, or school counselor? They can take real steps to help you and make things better.
                </div>
            `;
            
            const chatArea = document.getElementById('chatArea');
            chatArea.insertBefore(messageDiv, document.getElementById('typingIndicator'));
            chatArea.scrollTop = chatArea.scrollHeight;
            
            lastBotMessage = "Take a moment and breathe - you're doing great by reaching out. Now, I want to ask: have you been able to talk to any trusted adults about this - like your parents, a teacher, or school counselor? They can take real steps to help you and make things better.";
            hasShownHelpMessage = true;
        }

        function suggestHelpline() {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot';
            messageDiv.innerHTML = `
                <div class="message-bubble">
                    I understand it can be scary to talk to adults sometimes. That's okay - you're not alone in feeling that way.
                    <br><br>
                    If you don't have an adult you feel comfortable talking to right now, there's another option: you can reach out to <a href="tel:1098">CHILDLINE 1098</a>. They're trained counselors who are available 24/7, completely confidential, and they're there specifically to help students like you.
                    <br><br>
                    Is there anything else you'd like to talk about? I'm still here for you. üíô
                </div>
            `;
            
            const chatArea = document.getElementById('chatArea');
            chatArea.insertBefore(messageDiv, document.getElementById('typingIndicator'));
            chatArea.scrollTop = chatArea.scrollHeight;
            
            lastBotMessage = "I understand it can be scary to talk to adults sometimes. That's okay. If you don't have an adult you feel comfortable talking to right now, you can reach out to CHILDLINE 1098. They're available 24/7 and can help. Is there anything else you'd like to talk about? I'm still here for you.";
        }

        function addMessage(message, isUser) {
            const chatArea = document.getElementById('chatArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'bot'}`;
            
            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'message-bubble';
            bubbleDiv.innerHTML = message;
            
            messageDiv.appendChild(bubbleDiv);
            chatArea.insertBefore(messageDiv, document.getElementById('typingIndicator'));
            chatArea.scrollTop = chatArea.scrollHeight;
            
            if (!isUser) {
                lastBotMessage = message.replace(/<[^>]*>/g, '');
            }
        }

        function showTyping() {
            document.getElementById('typingIndicator').style.display = 'block';
            document.getElementById('chatArea').scrollTop = document.getElementById('chatArea').scrollHeight;
        }

        function hideTyping() {
            document.getElementById('typingIndicator').style.display = 'none';
        }

        function showGradeButtons_func() {
            const chatArea = document.getElementById('chatArea');
            const buttonsDiv = document.createElement('div');
            buttonsDiv.className = 'quick-buttons';
            buttonsDiv.innerHTML = `
                <div class="quick-button" onclick="quickReply('Elementary school')">üìö Elementary (1-4)</div>
                <div class="quick-button" onclick="quickReply('6th grade')">üìñ Middle School (5-8)</div>
                <div class="quick-button" onclick="quickReply('High school')">üéì High School (9-12)</div>
            `;
            chatArea.insertBefore(buttonsDiv, document.getElementById('typingIndicator'));
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        function showContextButtons_func() {
            const chatArea = document.getElementById('chatArea');
            const buttonsDiv = document.createElement('div');
            buttonsDiv.className = 'quick-buttons';
            buttonsDiv.innerHTML = `
                <div class="quick-button" onclick="quickReply('At school')">üè´ At School</div>
                <div class="quick-button" onclick="quickReply('Online')">üì± Online</div>
                <div class="quick-button" onclick="quickReply('Both')">üåê Both</div>
            `;
            chatArea.insertBefore(buttonsDiv, document.getElementById('typingIndicator'));
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        function quickReply(message) {
            const buttons = document.querySelectorAll('.quick-buttons');
            buttons.forEach(btn => btn.remove());
            document.getElementById('userInput').value = message;
            sendMessage();
        }

        function sendMessage() {
            const input = document.getElementById('userInput');
            const message = input.value.trim();
            
            if (message === '') return;
            
            addMessage(message, true);
            input.value = '';
            
            // Check if user mentioned talking to adults
            const lowerMsg = message.toLowerCase();
            if (hasShownHelpMessage && !hasTalkedToAdult) {
                if (lowerMsg.match(/\b(no|haven't|didn't|can't|won't|not yet|nobody|afraid)\b/i)) {
                    hasTalkedToAdult = false;
                    showTyping();
                    setTimeout(() => {
                        hideTyping();
                        suggestHelpline();
                    }, 1000);
                    return;
                } else if (lowerMsg.match(/\b(yes|talked|told|spoke|shared|will)\b/i)) {
                    hasTalkedToAdult = true;
                    showTyping();
                    setTimeout(() => {
                        hideTyping();
                        addMessage("That's wonderful! Having adult support is so important. They can help make sure you're safe and that action is taken. How did it go when you talked to them?", false);
                    }, 1000);
                    return;
                }
            }
            
            showTyping();
            
            setTimeout(() => {
                hideTyping();
                
                const { response, escalation, showGradeButtons, showContextButtons, isContextGathering } = getBotResponse(message);
                addMessage(response, false);
                
                if (showGradeButtons) {
                    setTimeout(() => showGradeButtons_func(), 500);
                } else if (showContextButtons) {
                    setTimeout(() => showContextButtons_func(), 500);
                }
                
                if (escalation) {
                    setTimeout(() => suggestHelpline(), 1000);
                    return;
                }
                
                // Count only problem discussion responses
                if (problemDiscussionStarted && !isContextGathering) {
                    responseCount--;
                    conversationTurns++;
                }
                
                // After 4 problem responses, ask about talking to adults
                if (problemDiscussionStarted && responseCount === 0 && !hasShownHelpMessage) {
                    setTimeout(() => checkAdultConversation(), 1500);
                }
            }, 800 + Math.random() * 700);
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') sendMessage();
        }

        function askQuestion(question) {
            document.getElementById('userInput').value = question;
            sendMessage();
        }

        function confirmNewChat() {
            document.getElementById('newChatModal').classList.add('active');
        }

        function closeNewChatModal() {
            document.getElementById('newChatModal').classList.remove('active');
        }

        function startNewChat() {
            const chatArea = document.getElementById('chatArea');
            chatArea.innerHTML = `
                <div class="message bot">
                    <div class="message-bubble">
                        Hey there! üëã I'm your Student Support Buddy. Before we start, what grade are you in? This helps me understand you better.
                    </div>
                </div>
                <div class="typing-indicator" id="typingIndicator">
                    <span></span><span></span><span></span>
                </div>
            `;
            
            responseCount = 4;
            conversationTurns = 0;
            hasShownHelpMessage = false;
            hasTalkedToAdult = false;
            problemDiscussionStarted = false;
            lastBotMessage = '';
            userContext = {
                ageGroup: null,
                bullyingType: null,
                hasBasicInfo: false
            };
            
            closeNewChatModal();
        }

        function speakMessage() {
            if (lastBotMessage === '') {
                alert('No message to speak yet!');
                return;
            }
            
            stopSpeaking();
            currentSpeech = new SpeechSynthesisUtterance(lastBotMessage);
            currentSpeech.rate = 0.9;
            document.getElementById('speakBtn').classList.add('active');
            currentSpeech.onend = () => document.getElementById('speakBtn').classList.remove('active');
            window.speechSynthesis.speak(currentSpeech);
        }

        function stopSpeaking() {
            window.speechSynthesis.cancel();
            document.getElementById('speakBtn').classList.remove('active');
        }

        function repeatMessage() {
            speakMessage();
        }

        document.addEventListener('gesturestart', e => e.preventDefault());
    </script>
</body>
</html>
